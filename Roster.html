<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Roster PPA Mart 2026</title>
<script src="https://cdn.tailwindcss.com"></script>

<style>
@media (max-width: 768px) {
  body { font-size: 11px; }
  td, th { padding: 3px 4px; }
}

th, td { white-space: nowrap; }

/* HEADER & LEFT STICKY */
.sticky-top {
  position: sticky;
  top: 0;
  z-index: 40;
  background: #e5e7eb;
}

.col-nik {
  position: sticky;
  left: 0;
  z-index: 60;
  background: #f9fafb;
  text-align: center;
  min-width: 80px;
}

.col-nama {
  position: sticky;
  left: 80px;
  z-index: 60;
  background: #fbf9f9;
  font-weight: 600;
  min-width: 160px;
}

/* SHIFT COLORS */
.shift-P{background:#016bfe;color:#fff;border:1px solid #222}
.shift-S{background:#02f902;color:#000;border:1px solid #222}
.shift-M{background:#fed669;color:#000;border:1px solid #222}
.shift-C{background:#747475;color:#fff;border:1px solid #222}
.shift-OFF{background:#fa0202;color:#fff;border:1px solid #222}
.shift-STN{background:#fafaf9;color:#000;border:1px solid #222}
.shift-IND{background:#fed669;color:#000;border:1px solid #222}
.shift-PMO{background:#0f766e;color:#fff;border:1px solid #222}
.shift-POP{background:#fbe602;color:#000;border:1px solid #222}
.shift-PMP{background:#fb923c;color:#000;border:1px solid #222}
.shift-SMP{background:#7c3aed;color:#fff;border:1px solid #222}
.shift-MOP{background:#fff;color:#000;border:1px solid #222}

/* TODAY */
.today-header,.today-col{
  border-left:3px solid #dc2626!important;
  border-right:3px solid #dc2626!important;
}

/* WIDTH */
td:not(.col-nik):not(.col-nama),
th:not(.col-nik):not(.col-nama){
  width:44px;min-width:44px;max-width:44px;
}

/* MONTH SEPARATOR */
.month-separator{
  width:8px;min-width:8px;
  background:repeating-linear-gradient(
    45deg,#d1d5db,#d1d5db 2px,#f9fafb 2px,#f9fafb 6px);
  border-left:2px solid #9ca3af;
  border-right:2px solid #9ca3af;
}

/* ACTION BAR */
.action-bar{
  position: sticky;
  bottom: 0;
  z-index: 70;
  background: #fff;
  border-top: 2px solid #e5e7eb;
}
</style>
</head>

<body class="p-4 text-xs" style="background:#f4f6f8">

<!-- HEADER -->
<div class="flex items-center gap-3 mb-3">
  <img src="Logo PPA Mart.png" class="h-14">
  <div>
    <h1 class="text-xl font-bold">Roster PPA Mart 2026</h1>
    <div class="text-xs text-gray-500">Koperasi Karyawan PPA Sejahtera</div>
  </div>
</div>

<!-- LEGEND -->
<div class="flex flex-wrap gap-2 mb-3 text-xs">
  <span class="shift-P px-2 py-1 rounded">P</span>
  <span class="shift-S px-2 py-1 rounded">S</span>
  <span class="shift-M px-2 py-1 rounded">M</span>
  <span class="shift-C px-2 py-1 rounded">C</span>
  <span class="shift-OFF px-2 py-1 rounded">OFF</span>
  <span class="shift-STN px-2 py-1 rounded">STN</span>
  <span class="shift-IND px-2 py-1 rounded">IND</span>
</div>

<!-- AREA ROSTER + PDF -->
<div id="pdfArea" class="overflow-auto bg-white rounded shadow max-h-[80vh]">
  <div class="flex gap-4 mb-2 text-xs text-gray-600 px-1">
    <div>Periode: <b data-periode>memuat...</b></div>
    <div id="lastUpdated">Last updated: memuat...</div>
  </div>

  <table id="rosterTable" class="border-collapse"></table>

  <!-- ACTION BAR -->
  <div class="action-bar p-2 text-xs">
    <div class="flex flex-wrap items-center gap-3">
      <button id="downloadKasir"
        class="px-3 py-1 rounded bg-blue-700 text-white">
        ⬇ CSV Kasir
      </button>

      <button id="downloadPDF"
        class="px-3 py-1 rounded bg-red-600 text-white hover:bg-red-700">
        ⬇ PDF
      </button>

      <div class="flex flex-wrap gap-3 text-gray-700">
        <span><b>P</b> 05–16</span>
        <span><b>P MP/OP</b> 06–17</span>
        <span><b>P MO</b> 07–18</span>
        <span><b>M</b> 08–19</span>
        <span><b>M OP</b> 17–04</span>
        <span><b>S</b> 11–22</span>
        <span><b>S MP</b> 10.30–21.30</span>
        <span><b>STN</b> 09–20</span>
        <span><b>IND</b> 11–22</span>
      </div>
    </div>
  </div>
</div>

<!-- LIBRARY PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<!-- SCRIPT ROSTER -->
<script>
fetch('Roster.csv',{cache:'no-store'})
.then(res=>{
  const lm=res.headers.get('Last-Modified');
  document.getElementById('lastUpdated').innerText =
    'Last updated: '+(lm?new Date(lm).toLocaleString('id-ID'):'baru saja');
  return res.text();
})
.then(text=>{
  const rows=text.trim().split('\n').map(r=>r.split(';').map(c=>c.trim()));
  const today=new Date();today.setHours(0,0,0,0);
  const end=new Date(today);end.setDate(today.getDate()+30);

  const idx=[],dates=[];
  rows[0].forEach((h,i)=>{
    if(i<2){idx.push(i);return;}
    const d=new Date(h);
    if(!isNaN(d)&&d>=today&&d<=end){idx.push(i);dates.push(d);}
  });

  if(dates.length){
    const b=['Jan','Feb','Mar','Apr','Mei','Jun','Jul','Agu','Sep','Okt','Nov','Des'];
    const s=dates[0],e=dates.at(-1);
    document.querySelector('[data-periode]').innerText =
      s.getMonth()===e.getMonth()?`${b[s.getMonth()]} ${s.getFullYear()}`
      :`${b[s.getMonth()]}–${b[e.getMonth()]} ${e.getFullYear()}`;
  }

  let html='<thead><tr class="sticky-top">',lastM=null;
  idx.forEach(i=>{
    if(i===0){html+='<th class="col-nik border">NIK</th>';return;}
    if(i===1){html+='<th class="col-nama border">NAMA</th>';return;}
    const d=new Date(rows[0][i]);
    if(lastM!==null&&d.getMonth()!==lastM)html+='<th class="month-separator"></th>';
    html+=`<th class="border text-center ${d.getTime()===today.getTime()?'today-header':''}">${d.getDate()}</th>`;
    lastM=d.getMonth();
  });
  html+='</tr></thead><tbody>';

  rows.slice(1).forEach(r=>{
    const sec=r[0]?.toUpperCase();
    if(['KASIR','OPERASIONAL','BACK OFFICE'].includes(sec)){
      html+=`<tr class="bg-slate-800 text-white">
        <td colspan="${idx.length*2}" class="px-3 py-2 font-bold">${sec}</td></tr>`;
      return;
    }
    html+='<tr>';lastM=null;
    idx.forEach(i=>{
      if(i<2){
        html+=`<td class="border ${i===0?'col-nik':'col-nama'}">${r[i]||''}</td>`;
        return;
      }
      const d=new Date(rows[0][i]);
      if(lastM!==null&&d.getMonth()!==lastM)html+='<td class="month-separator"></td>';
      html+=`<td class="border text-center shift-${(r[i]||'').replace(/\s/g,'')} ${d.getTime()===today.getTime()?'today-col':''}">${r[i]||''}</td>`;
      lastM=d.getMonth();
    });
    html+='</tr>';
  });

  document.getElementById('rosterTable').innerHTML=html+'</tbody>';
});
</script>

<!-- SCRIPT PDF -->
<script>
document.getElementById('downloadPDF').onclick = () => {
  const el = document.getElementById('pdfArea');
  html2pdf().set({
    margin: 5,
    filename: 'Roster_PPA_Mart_2026.pdf',
    image: { type: 'jpeg', quality: 0.95 },
    html2canvas: { scale: 2, scrollY: 0 },
    jsPDF: { unit: 'mm', format: 'a3', orientation: 'landscape' }
  }).from(el).save();
};
</script>

</body>
</html>
